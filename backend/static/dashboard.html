<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Workout Streak Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v=3">
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <div class="app-icon-container">üí™</div>
                <div class="header-text">
                    <h1>Workout Tracker</h1>
                    <p class="welcome-text">Hey <span id="user-name">...</span>, let's crush it today!</p>
                </div>
            </div>
            <button id="logout-btn" class="logout-btn">
                <span>Sign Out</span>
            </button>
        </header>

        <!-- Top Stats Row -->
        <section class="stats-row">
            <div class="stat-box streak-box">
                <div class="box-icon">üî•</div>
                <div class="box-info">
                    <span class="label">Current Streak</span>
                    <h2 id="current-streak">0</h2>
                    <span class="subtext">Days in a row</span>
                </div>
            </div>

            <div class="stat-box total-box">
                <div class="box-icon">üìà</div>
                <div class="box-info">
                    <span class="label">Total Workouts</span>
                    <h2 id="total-workouts">0</h2>
                    <span class="subtext">Sessions tracked</span>
                </div>
            </div>

            <div class="stat-box status-box" id="today-card">
                <div class="box-icon" id="today-icon">‚ö°</div>
                <div class="box-info">
                    <span class="label" id="today-date-top">Today</span>
                    <h2 id="today-status-text">Pending</h2>
                    <span class="subtext" id="today-status-sub">Mark as complete</span>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="dashboard-grid">
            <!-- Calendar Table Area -->
            <div class="calendar-container-panel">
                <div class="panel-header">
                    <div class="title-group">
                        <h2>Workout Calendar</h2>
                        <p>Track your consistency visually</p>
                    </div>
                    <div class="calendar-controls">
                        <button id="prev-month" class="nav-btn">‚Üê</button>
                        <span id="current-month-display">...</span>
                        <button id="next-month" class="nav-btn">‚Üí</button>
                    </div>
                </div>

                <div class="calendar-table-scroll">
                    <table class="workout-table">
                        <thead>
                            <tr>
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>

                <div class="calendar-footer">
                    <div class="legend">
                        <div class="legend-item"><span class="dot done"></span> Completed</div>
                        <div class="legend-item"><span class="dot today"></span> Today</div>
                    </div>
                </div>
            </div>

            <!-- Side Sidebar -->
            <aside class="dashboard-sidebar">
                <div class="quick-action-panel">
                    <button id="mark-workout-btn" class="primary-mark-btn">
                        <span class="btn-check">‚úì</span>
                        Mark Done For Today
                    </button>
                    <p id="action-message" class="action-message"></p>
                </div>

                <div class="leaderboard-panel">
                    <div class="sidebar-header">
                        <h3>üèÜ Leaderboard</h3>
                    </div>
                    <div id="leaderboard" class="leaderboard-list">
                        <p class="loading-state">Syncing ranks...</p>
                    </div>
                    <div class="pagination-footer" id="leaderboard-pagination" style="display: none;">
                        <button id="prev-page" class="pager-btn">‚Üê</button>
                        <span id="page-info">1/1</span>
                        <button id="next-page" class="pager-btn">‚Üí</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let dashboardData = null;
        let currentCalendarDate = new Date();
        let workoutDates = new Set();
        let allLeaderboardData = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard', { credentials: 'include' });
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/';
                    return;
                }
                dashboardData = await response.json();
                renderDashboard(dashboardData);
                loadLeaderboard();
            } catch (error) {
                console.error(error);
                showActionMessage('Sync failed', 'error');
            }
        }

        function renderDashboard(data) {
            document.getElementById('user-name').textContent = data.name;
            document.getElementById('current-streak').textContent = data.current_streak;
            document.getElementById('total-workouts').textContent = data.total_workout_days;

            const todayDate = new Date(data.today_date);
            document.getElementById('today-date-top').textContent = todayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            const todayCard = document.getElementById('today-card');
            const todayText = document.getElementById('today-status-text');
            const todaySub = document.getElementById('today-status-sub');
            const todayIcon = document.getElementById('today-icon');
            const markBtn = document.getElementById('mark-workout-btn');

            if (data.today_marked) {
                todayText.textContent = 'Completed';
                todaySub.textContent = 'Goal reached!';
                todayIcon.textContent = '‚úÖ';
                todayCard.classList.add('status-done');
                markBtn.disabled = true;
                markBtn.textContent = '‚úì Target Achieved';
            } else {
                todayText.textContent = 'Pending';
                todaySub.textContent = 'Click to mark';
                todayIcon.textContent = '‚ö°';
                todayCard.classList.remove('status-done');
                markBtn.disabled = false;
                markBtn.textContent = '‚úì Mark Done For Today';
                todayCard.onclick = () => handleMarkWorkout();
            }

            workoutDates = new Set(data.workout_history.map(w => w.date));
            renderCalendar();
        }

        function renderCalendar() {
            const tbody = document.getElementById('calendar-body');
            const display = document.getElementById('current-month-display');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            display.textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentCalendarDate);

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const todayStr = getTodayStr();
            const todayObj = new Date();
            todayObj.setHours(0, 0, 0, 0);

            tbody.innerHTML = '';
            let date = 1;

            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                let rowAdded = false;
                for (let j = 0; j < 7; j++) {
                    const td = document.createElement('td');
                    if (i === 0 && j < firstDay) {
                        td.className = 'empty-cell';
                    } else if (date > lastDate) {
                        td.className = 'empty-cell';
                    } else {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        const cellDate = new Date(year, month, date);

                        td.className = 'date-cell';
                        td.innerHTML = `<div class="date-num">${date}</div>`;

                        if (workoutDates.has(dateStr)) {
                            td.classList.add('workout-done');
                        } else if (cellDate <= todayObj) {
                            // Any past date or today can be marked if not done
                            td.classList.add('quick-mark');
                            const capturedDate = dateStr;
                            td.onclick = () => handleMarkWorkout(capturedDate);
                        }

                        if (dateStr === todayStr) {
                            td.classList.add('is-today');
                        }
                        date++;
                        rowAdded = true;
                    }
                    row.appendChild(td);
                }
                if (rowAdded) tbody.appendChild(row);
            }
        }

        async function handleMarkWorkout(date = null) {
            // Ignore the event object if called directly via onclick
            if (date && typeof date !== 'string') date = null;

            const btn = document.getElementById('mark-workout-btn');
            const originalText = btn.textContent;

            if (!date) {
                if (btn.disabled) return;
                btn.disabled = true;
                btn.textContent = 'Syncing...';
            }

            try {
                const response = await fetch('/api/mark-workout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showActionMessage('üéâ Entry recorded!', 'success');
                    setTimeout(loadDashboard, 800);
                } else {
                    showActionMessage(result.message || 'Failed', 'error');
                    if (!date) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                }
            } catch (error) {
                showActionMessage('Network error', 'error');
                if (!date) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }
        function getTodayStr() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard', { credentials: 'include' });
                if (response.ok) {
                    allLeaderboardData = await response.json();
                    renderLeaderboardPage(1);
                }
            } catch (error) { console.error(error); }
        }

        function renderLeaderboardPage(page) {
            currentPage = page;
            const container = document.getElementById('leaderboard');
            const totalPages = Math.ceil(allLeaderboardData.length / itemsPerPage);
            const data = allLeaderboardData.slice((page - 1) * itemsPerPage, page * itemsPerPage);

            if (data.length === 0) {
                container.innerHTML = '<p class="empty">No entries yet</p>';
                return;
            }

            container.innerHTML = data.map(u => `
                <div class="rank-item ${u.is_current_user ? 'self' : ''}">
                    <span class="rank-id">${u.rank <= 3 ? ['ü•á', 'ü•à', 'ü•â'][u.rank - 1] : '#' + u.rank}</span>
                    <span class="user-info">${u.name}${u.is_current_user ? ' (Me)' : ''}</span>
                    <div class="user-stats">üî• ${u.current_streak} | üìà ${u.total_workout_days}</div>
                </div>
            `).join('');

            const pag = document.getElementById('leaderboard-pagination');
            if (allLeaderboardData.length > itemsPerPage) {
                pag.style.display = 'flex';
                document.getElementById('page-info').textContent = `${page}/${totalPages}`;
                document.getElementById('prev-page').disabled = page === 1;
                document.getElementById('next-page').disabled = page === totalPages;
            } else {
                pag.style.display = 'none';
            }
        }

        document.getElementById('prev-page').onclick = () => renderLeaderboardPage(currentPage - 1);
        document.getElementById('next-page').onclick = () => renderLeaderboardPage(currentPage + 1);
        document.getElementById('prev-month').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); };
        document.getElementById('mark-workout-btn').onclick = () => handleMarkWorkout();
        document.getElementById('logout-btn').onclick = async () => { await fetch('/api/logout', { method: 'POST', credentials: 'include' }); window.location.href = '/'; };

        function showActionMessage(text, type) {
            const el = document.getElementById('action-message');
            el.textContent = text;
            el.className = `action-message ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        loadDashboard();
    </script>
</body>

</html>