<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker | Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v=5">
</head>

<body>
    <div class="auth-container">
        <main class="auth-card">
            <header class="auth-header">
                <span class="logo">üí™</span>
                <h1>Workout Tracker</h1>
                <p>Welcome back! Let's hit those goals.</p>
            </header>

            <nav class="auth-tabs">
                <button class="auth-tab-btn active" data-tab="login">Login</button>
                <button class="auth-tab-btn" data-tab="register">Register</button>
            </nav>

            <!-- Login Form -->
            <section id="login-form-container" class="form-container active">
                <form id="loginForm">
                    <div class="auth-form-group">
                        <label for="login-name">Username or Name</label>
                        <input type="text" id="login-name" name="name" class="auth-input" placeholder="e.g. Sivan"
                            required autocomplete="username">
                    </div>
                    <div class="auth-form-group">
                        <label for="login-pin">4-Digit Access PIN</label>
                        <input type="password" id="login-pin" name="pin" class="auth-input" maxlength="4"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" pattern="[0-9]{4}" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="auth-submit-btn">Continue to Dashboard</button>
                </form>
            </section>

            <!-- Register Form -->
            <section id="register-form-container" class="form-container">
                <form id="registerForm">
                    <div class="auth-form-group">
                        <label for="register-name">Display Name</label>
                        <input type="text" id="register-name" name="name" class="auth-input"
                            placeholder="How should we call you?" required autocomplete="username">
                    </div>
                    <div class="auth-form-group">
                        <label for="register-pin">Create 4-Digit PIN</label>
                        <input type="password" id="register-pin" name="pin" class="auth-input" maxlength="4"
                            placeholder="Choose 4 digits" pattern="[0-9]{4}" required autocomplete="new-password">
                    </div>
                    <div class="auth-form-group">
                        <label for="register-pin-confirm">Confirm Secret PIN</label>
                        <input type="password" id="register-pin-confirm" name="pin_confirm" class="auth-input"
                            maxlength="4" placeholder="Repeat PIN" pattern="[0-9]{4}" required
                            autocomplete="new-password">
                    </div>
                    <button type="submit" class="auth-submit-btn">Create Free Account</button>
                </form>
            </section>

            <div id="auth-message" class="auth-message"></div>
        </main>
    </div>

    <script>
        // Tab switching logic
        document.querySelectorAll('.auth-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                // Update tabs
                document.querySelectorAll('.auth-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update forms
                document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
                document.getElementById(`${tab}-form-container`).classList.add('active');

                // Clear state
                const msg = document.getElementById('auth-message');
                msg.style.display = 'none';

                // Update header text based on tab
                const headerP = document.querySelector('.auth-header p');
                headerP.textContent = tab === 'login' ? 'Welcome back! Let\'s hit those goals.' : 'Join the community and track your wins.';
            });
        });

        // Shared display message function
        function showMsg(text, type) {
            const el = document.getElementById('auth-message');
            el.textContent = text;
            el.className = `auth-message ${type}`;
            el.style.display = 'block';
        }

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                pin: formData.get('pin')
            };

            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Verifying...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showMsg('‚úÖ Security cleared! Entering...', 'success');
                    setTimeout(() => window.location.href = '/static/dashboard.html', 800);
                } else {
                    showMsg('‚ùå ' + (result.detail || 'Access denied. Check your name or PIN.'), 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                showMsg('‚ùå Connection error. Is the server running?', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Register Handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                pin: formData.get('pin'),
                pin_confirm: formData.get('pin_confirm')
            };

            if (data.pin !== data.pin_confirm) {
                showMsg('‚ö†Ô∏è PINs do not match. Please try again.', 'error');
                return;
            }

            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Creating Account...';

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: data.name, pin: data.pin }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showMsg('üéâ Account ready! Welcome aboard.', 'success');
                    setTimeout(() => window.location.href = '/static/dashboard.html', 1000);
                } else {
                    showMsg('‚ùå ' + (result.detail || 'Something went wrong.'), 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                showMsg('‚ùå Registration failed. Try again later.', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    </script>
</body>

</html>